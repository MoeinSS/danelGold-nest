{"version":3,"sources":["../../src/user-detail/userDetail.service.ts"],"sourcesContent":["import { ApiResponses } from '@/utils/response.util';\r\nimport {\r\n  BadRequestException,\r\n  Injectable,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { Repository } from 'typeorm';\r\nimport { UserDetail } from './entity/userDetail.entity';\r\nimport { CreateUserDetailDTO } from './dto/create-userDetail.dto';\r\nimport { UpdateUserDetailDTO } from './dto/update-userDetail.dto';\r\nimport { User } from '@/user/entity/user.entity';\r\nimport {\r\n  PaginationResult,\r\n  PaginationService,\r\n} from '@/common/paginate/pagitnate.service';\r\nimport { createResponse } from '@/utils/response.util';\r\n\r\n@Injectable()\r\nexport class UserDetailService {\r\n  constructor(\r\n    @InjectRepository(UserDetail)\r\n    private readonly userDetailRepository: Repository<UserDetail>,\r\n    @InjectRepository(User)\r\n    private readonly userRepository: Repository<User>,\r\n    private readonly paginationService: PaginationService,\r\n  ) {}\r\n\r\n  async createUserDetail(\r\n    userPhone: string,\r\n    userAgent: any,\r\n  ): Promise<UserDetail[]> {\r\n    const user = await this.userRepository.findOne({\r\n      where: { phone: userPhone },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n\r\n    const newUserDetail = this.userDetailRepository.create({\r\n      user,\r\n      ...userAgent,\r\n      loginDate: new Date(),\r\n    });\r\n\r\n    return await this.userDetailRepository.save(newUserDetail);\r\n  }\r\n\r\n  async getUserDetail(\r\n    userPhone: string,\r\n    query: any,\r\n  ): Promise<ApiResponses<PaginationResult<UserDetail>>> {\r\n    const { page, limit, sort, sortOrder } = query;\r\n\r\n    const queryBuilder = this.userDetailRepository\r\n      .createQueryBuilder('userDetail')\r\n      .leftJoin('userDetail.user', 'user')\r\n      .where('user.phone = :userPhone', { userPhone });\r\n\r\n    if (sort && sortOrder) {\r\n      queryBuilder.orderBy(`userDetail.${sort}`, sortOrder);\r\n    } else {\r\n      queryBuilder.orderBy('userDetail.loginDate', 'DESC');\r\n    }\r\n\r\n    const paginationResult = await this.paginationService.paginate(\r\n      queryBuilder,\r\n      page,\r\n      limit,\r\n    );\r\n\r\n    if (paginationResult.total === 0) {\r\n      throw new NotFoundException('اطلاعات کاربر یافت نشد');\r\n    }\r\n\r\n    return createResponse(200, paginationResult);\r\n  }\r\n\r\n  async updateUserDetail(\r\n    userPhone: string,\r\n    updateUserDetailDTO: UpdateUserDetailDTO,\r\n  ): Promise<UserDetail> {\r\n    const user = await this.userRepository.findOne({\r\n      where: { phone: userPhone },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n\r\n    let userDetail = await this.userDetailRepository.findOne({\r\n      where: { user: { phone: userPhone } },\r\n    });\r\n\r\n    if (!userDetail) {\r\n      userDetail = this.userDetailRepository.create({\r\n        ...updateUserDetailDTO,\r\n        user,\r\n      });\r\n    } else {\r\n      Object.assign(userDetail, updateUserDetailDTO);\r\n    }\r\n\r\n    return await this.userDetailRepository.save(userDetail);\r\n  }\r\n\r\n  async deleteUserDetail(userPhone: string): Promise<void> {\r\n    const user = await this.userRepository.findOne({\r\n      where: { phone: userPhone },\r\n    });\r\n    if (!user) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n\r\n    let userDetail = await this.userDetailRepository.findOne({\r\n      where: { user: { phone: userPhone } },\r\n    });\r\n\r\n    await this.userDetailRepository.remove(userDetail);\r\n  }\r\n}\r\n"],"names":["UserDetailService","createUserDetail","userPhone","userAgent","user","userRepository","findOne","where","phone","NotFoundException","newUserDetail","userDetailRepository","create","loginDate","Date","save","getUserDetail","query","page","limit","sort","sortOrder","queryBuilder","createQueryBuilder","leftJoin","orderBy","paginationResult","paginationService","paginate","total","createResponse","updateUserDetail","updateUserDetailDTO","userDetail","Object","assign","deleteUserDetail","remove","constructor"],"mappings":";;;;+BAmBaA;;;eAAAA;;;wBAdN;yBAC0B;0BACN;kCACA;4BAGN;kCAId;8BACwB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGxB,IAAA,AAAMA,oBAAN,MAAMA;IASLC,iBACJC,SAAiB,EACjBC,SAAc;;eAFhB,oBAAA;YAIE,MAAMC,OAAO,MAAM,MAAKC,cAAc,CAACC,OAAO,CAAC;gBAC7CC,OAAO;oBAAEC,OAAON;gBAAU;YAC5B;YAEA,IAAI,CAACE,MAAM;gBACT,MAAM,IAAIK,yBAAiB,CAAC;YAC9B;YAEA,MAAMC,gBAAgB,MAAKC,oBAAoB,CAACC,MAAM,CAAC;gBACrDR;eACGD;gBACHU,WAAW,IAAIC;;YAGjB,OAAO,MAAM,MAAKH,oBAAoB,CAACI,IAAI,CAACL;QAC9C;;IAEMM,cACJd,SAAiB,EACjBe,KAAU;;eAFZ,oBAAA;YAIE,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAEC,IAAI,EAAEC,SAAS,EAAE,GAAGJ;YAEzC,MAAMK,eAAe,MAAKX,oBAAoB,CAC3CY,kBAAkB,CAAC,cACnBC,QAAQ,CAAC,mBAAmB,QAC5BjB,KAAK,CAAC,2BAA2B;gBAAEL;YAAU;YAEhD,IAAIkB,QAAQC,WAAW;gBACrBC,aAAaG,OAAO,CAAC,CAAC,WAAW,EAAEL,KAAK,CAAC,EAAEC;YAC7C,OAAO;gBACLC,aAAaG,OAAO,CAAC,wBAAwB;YAC/C;YAEA,MAAMC,mBAAmB,MAAM,MAAKC,iBAAiB,CAACC,QAAQ,CAC5DN,cACAJ,MACAC;YAGF,IAAIO,iBAAiBG,KAAK,KAAK,GAAG;gBAChC,MAAM,IAAIpB,yBAAiB,CAAC;YAC9B;YAEA,OAAOqB,IAAAA,4BAAc,EAAC,KAAKJ;QAC7B;;IAEMK,iBACJ7B,SAAiB,EACjB8B,mBAAwC;;eAF1C,oBAAA;YAIE,MAAM5B,OAAO,MAAM,MAAKC,cAAc,CAACC,OAAO,CAAC;gBAC7CC,OAAO;oBAAEC,OAAON;gBAAU;YAC5B;YAEA,IAAI,CAACE,MAAM;gBACT,MAAM,IAAIK,yBAAiB,CAAC;YAC9B;YAEA,IAAIwB,aAAa,MAAM,MAAKtB,oBAAoB,CAACL,OAAO,CAAC;gBACvDC,OAAO;oBAAEH,MAAM;wBAAEI,OAAON;oBAAU;gBAAE;YACtC;YAEA,IAAI,CAAC+B,YAAY;gBACfA,aAAa,MAAKtB,oBAAoB,CAACC,MAAM,CAAC,wCACzCoB;oBACH5B;;YAEJ,OAAO;gBACL8B,OAAOC,MAAM,CAACF,YAAYD;YAC5B;YAEA,OAAO,MAAM,MAAKrB,oBAAoB,CAACI,IAAI,CAACkB;QAC9C;;IAEMG,iBAAiBlC,SAAiB;;eAAxC,oBAAA;YACE,MAAME,OAAO,MAAM,MAAKC,cAAc,CAACC,OAAO,CAAC;gBAC7CC,OAAO;oBAAEC,OAAON;gBAAU;YAC5B;YACA,IAAI,CAACE,MAAM;gBACT,MAAM,IAAIK,yBAAiB,CAAC;YAC9B;YAEA,IAAIwB,aAAa,MAAM,MAAKtB,oBAAoB,CAACL,OAAO,CAAC;gBACvDC,OAAO;oBAAEH,MAAM;wBAAEI,OAAON;oBAAU;gBAAE;YACtC;YAEA,MAAM,MAAKS,oBAAoB,CAAC0B,MAAM,CAACJ;QACzC;;IApGAK,YACE,AACiB3B,oBAA4C,EAC7D,AACiBN,cAAgC,EACjD,AAAiBsB,iBAAoC,CACrD;aAJiBhB,uBAAAA;aAEAN,iBAAAA;aACAsB,oBAAAA;IAChB;AA+FL"}