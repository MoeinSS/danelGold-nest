{"version":3,"sources":["../../src/user/user.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ConflictException, UnauthorizedException, BadRequestException } from '@nestjs/common';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { Repository } from 'typeorm/index';\r\nimport * as bcrypt from 'bcryptjs';\r\nimport { User, UserRole } from '@/user/entity/user.entity';\r\nimport { SignupDto } from '@/auth/dto/signup-dto';\r\nimport { UpdateUserDTO } from '@/user/dto/update-user.dto';\r\nimport { ApiResponses, createResponse } from '@/utils/response.util';\r\nimport { UserInformation } from '@/user/interface/userInformation.interface';\r\nimport { Subscribe } from '@/subscribe/entity/subscribe.entity';\r\nimport { Token } from '@/auth/token/entity/token.entity';\r\nimport { SmsService } from '@/services/sms.service';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { editDateUser } from '@/user/dto/edit-user-date.dto';\r\nimport { CreateUserByAdminDTO } from './dto/create-user.dto';\r\nimport { PaginationResult } from '@/common/paginate/pagitnate.service';\r\n\r\n@Injectable()\r\nexport class UserService {\r\n  constructor(\r\n    @InjectRepository(User)\r\n    private userRepository: Repository<User>,\r\n    @InjectRepository(Token)\r\n    private readonly tokenRepository: Repository<Token>,\r\n    private readonly smsService: SmsService,\r\n  ) {}\r\n\r\n  async singupUser(createUserDTO: SignupDto) {\r\n    const existingUser = await this.userRepository.findOne({\r\n      where: { phone: createUserDTO.phone },\r\n    });\r\n\r\n    if (existingUser) {\r\n      throw new BadRequestException(\r\n        'کاربری با این شماره همراه قبلاً حساب کاربری ساخته است',\r\n      );\r\n    }\r\n\r\n    const NewUser = this.userRepository.create({\r\n      ...createUserDTO,\r\n    });\r\n\r\n    const result = await this.userRepository.save(NewUser);\r\n    return result;\r\n  }\r\n\r\n  async createUser(createUserDTO: CreateUserByAdminDTO) {\r\n    const existingUser = await this.userRepository.findOne({\r\n      where: { phone: createUserDTO.phone },\r\n    });\r\n\r\n    if (existingUser) {\r\n      throw new BadRequestException(\r\n        'کاربری با این شماره همراه قبلاً حساب کاربری ساخته است',\r\n      );\r\n    }\r\n\r\n    const hashedPassword = await bcrypt.hash(createUserDTO.password, 10);\r\n\r\n    const NewUser = this.userRepository.create({\r\n      ...createUserDTO,\r\n      password: hashedPassword,\r\n      createdAt: new Date(),\r\n    });\r\n\r\n    const result = await this.userRepository.save(NewUser);\r\n\r\n    if (createUserDTO.isSms) {\r\n      await this.smsService.sendSignUpSMS(\r\n        createUserDTO.phone,\r\n        createUserDTO.phone,\r\n        createUserDTO.password,\r\n      );\r\n    }\r\n\r\n    return createResponse(201, result, 'کاربر با موفقیت ایجاد گردید');\r\n  }\r\n\r\n  async updateUser(\r\n    phone: string,\r\n    updateUserDTO: UpdateUserDTO,\r\n  ): Promise<ApiResponses<User>> {\r\n    const existingUser = await this.userRepository.findOne({\r\n      where: { phone: phone },\r\n    });\r\n\r\n    if (!existingUser) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n\r\n    const hashedPassword = updateUserDTO.password\r\n      ? await bcrypt.hash(updateUserDTO.password, 10)\r\n      : existingUser.password;\r\n\r\n    Object.assign(existingUser, {\r\n      ...updateUserDTO,\r\n      password: hashedPassword,\r\n      updatedAt: new Date(),\r\n    });\r\n\r\n    const updateUser = await this.userRepository.save(existingUser);\r\n    return createResponse(200, updateUser, 'آپدیت شد');\r\n  }\r\n\r\n  async deleteUsers(phone: string): Promise<string> {\r\n    const user = await this.userRepository.findOne({ where: { phone } });\r\n    if (!user) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n    \r\n    await this.userRepository.manager.transaction(\r\n      async (transactionalEntityManager) => {\r\n        await transactionalEntityManager.delete(Subscribe, {\r\n          userPhone: phone,\r\n        });\r\n        await transactionalEntityManager.delete(User, { phone });\r\n      },\r\n    );\r\n\r\n    return 'کاربر با موفقیت پاک شد';\r\n  }\r\n\r\n  async getUserByPhone(phone: string): Promise<ApiResponses<UserInformation>> {\r\n    const user = await this.userRepository.findOneBy({ phone });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('کاربر یافت نشد');\r\n    }\r\n\r\n    const userInformation: UserInformation = {\r\n      id: user.id,\r\n      firstName: user.firstName,\r\n      lastName: user.lastName,\r\n      phone: user.phone,\r\n      roles: user.role,\r\n      imageUrl: user.imageUrl,\r\n      createdAt: user.createdAt,\r\n      updatedAt: user.updatedAt,\r\n    };\r\n    const result = userInformation;\r\n    return createResponse(200, result, null);\r\n  }\r\n\r\n  async getUsers(\r\n    page: number = 1,\r\n    limit: number = 10,\r\n    searchInput?: string,\r\n    role?: string,\r\n    all?: string,\r\n    sort: string = 'id',\r\n    sortOrder: 'ASC' | 'DESC' = 'DESC',\r\n  ): Promise<ApiResponses<PaginationResult<any>>> {\r\n    const allowedSortFields = [\r\n      'id',\r\n      'firstName',\r\n      'lastName',\r\n      'phone',\r\n      'roles',\r\n      'grade',\r\n      'lastLogin',\r\n      'skuTest',\r\n    ];\r\n\r\n    const validatedSortBy = allowedSortFields.includes(sort) ? sort : 'id';\r\n\r\n    let queryBuilder = this.userRepository\r\n      .createQueryBuilder('user')\r\n      .leftJoinAndSelect('user.userDetail', 'userDetail')\r\n      .select([\r\n        'user.id as id',\r\n        'user.firstName as firstName',\r\n        'user.lastName as lastName',\r\n        'user.phone as phone',\r\n        'user.role as role',\r\n        'user.grade as grade',\r\n        'user.lastLogin as lastLogin',\r\n        'user.skuTest as skuTest',\r\n        'MAX(userDetail.ip) as ip',\r\n        'MAX(userDetail.platform) as platform',\r\n        'MAX(userDetail.browser) as browser',\r\n        'MAX(userDetail.versionBrowser) as versionBrowser',\r\n        'MAX(userDetail.versionPlatform) as versionPlatform',\r\n        'MAX(userDetail.loginDate) as lastLoginDate',\r\n      ])\r\n      .groupBy(\r\n        'user.id, user.firstName, user.lastName, user.phone, user.roles, user.grade, user.lastLogin, user.skuTest',\r\n      )\r\n      .orderBy(`user.${validatedSortBy}`, sortOrder);\r\n\r\n    if (searchInput) {\r\n      queryBuilder = queryBuilder.andWhere(\r\n        `(CONCAT(user.firstName, ' ', user.lastName) ILIKE :searchInput OR user.phone ILIKE :searchInput OR CAST(user.skuTest AS TEXT) ILIKE :searchInput)`,\r\n        { searchInput: `%${searchInput}%` },\r\n      );\r\n    }\r\n\r\n    if (role !== undefined && role !== '') {\r\n      queryBuilder = queryBuilder.andWhere('user.roles = :roles', { role });\r\n    }\r\n\r\n    if (all === 'true') {\r\n      const users = await queryBuilder.getRawMany();\r\n      const adminCount = await this.userRepository.count({\r\n        where: { role: UserRole.ADMIN},\r\n      });\r\n      const userCount = await this.userRepository.count({\r\n        where: { role: UserRole.USER },\r\n      });\r\n      const response = {\r\n        data: users,\r\n        total: users.length,\r\n        adminCount,\r\n        userCount,\r\n        totalPages: 1,\r\n        page: 1,\r\n        limit: users.length,\r\n      };\r\n\r\n      return createResponse(200, response);\r\n    }\r\n\r\n    const offset = (page - 1) * limit;\r\n    queryBuilder = queryBuilder.skip(offset).take(limit);\r\n    const users = await queryBuilder.getRawMany();\r\n\r\n    const total = await this.userRepository.count();\r\n    const totalPages = Math.ceil(total / limit);\r\n    const response = {\r\n      data: users,\r\n      total,\r\n      totalPages,\r\n      page,\r\n      limit,\r\n    };\r\n\r\n    return createResponse(200, response);\r\n  }\r\n\r\n  async getAdminCount(): Promise<number> {\r\n    return this.userRepository.count({ where: { role: UserRole.ADMIN } });\r\n  }\r\n\r\n  async getUserCount(): Promise<number> {\r\n    return this.userRepository.count({ where: { role: UserRole.ADMIN } });\r\n  }\r\n\r\n\r\n  async getUserDataWithToken(userPhone: string) {\r\n    const existingUser = await this.userRepository\r\n      .createQueryBuilder('user')\r\n      .leftJoin('user.subscribes', 'subscribe')\r\n      .leftJoin('user.userDetail', 'userDetail')\r\n      .where('user.phone = :phone', { phone: userPhone })\r\n      .orderBy('userDetail.loginDate', 'DESC')\r\n      .select([\r\n        'user.id',\r\n        'user.firstName',\r\n        'user.lastName',\r\n        'user.phone',\r\n        'user.imageUrl',\r\n        'user.createdAt',\r\n        'user.updatedAt',\r\n        'user.lastLogin',\r\n        'userDetail.ip',\r\n        'userDetail.platform',\r\n        'userDetail.browser',\r\n        'userDetail.versionBrowser',\r\n        'userDetail.versionPlatform',\r\n        'userDetail.loginDate',\r\n        'subscribe.isActive',\r\n      ])\r\n      .limit(1)\r\n      .getOne();\r\n\r\n    if (existingUser) {\r\n      return existingUser;\r\n    } else {\r\n      return { error: 'کاربری با این شماره پیدا نشد', status: 404 };\r\n    }\r\n  }\r\n\r\n  async editDataUser(authHeader: string, editData: editDateUser) {\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      throw new UnauthorizedException('توکن وجود ندارد');\r\n    }\r\n\r\n    const token = authHeader.split(' ')[1];\r\n\r\n    const tokenData = await this.tokenRepository\r\n      .createQueryBuilder('token')\r\n      .leftJoin('token.user', 'user')\r\n      .where('token.token = :token', { token })\r\n      .select(['token.token', 'user.phone'])\r\n      .getOne();\r\n\r\n    if (!tokenData) {\r\n      throw new UnauthorizedException('توکن اشتباه است');\r\n    }\r\n\r\n    const updateData: Partial<User> = {\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    if (editData.firstName !== undefined) {\r\n      updateData.firstName = editData.firstName;\r\n    }\r\n    if (editData.lastName !== undefined) {\r\n      updateData.lastName = editData.lastName;\r\n    }\r\n    if (editData.imageUrl !== undefined) {\r\n      updateData.imageUrl = editData.imageUrl;\r\n    }\r\n\r\n    if (Object.keys(updateData).length > 1) {\r\n      const updatedUser = await this.userRepository\r\n        .createQueryBuilder()\r\n        .update(User)\r\n        .set(updateData)\r\n        .where('phone = :phone', { phone: tokenData.user.phone })\r\n        .returning([\r\n          'phone',\r\n          'firstName',\r\n          'lastName',\r\n          'imageUrl',\r\n          'updatedAt',\r\n        ])\r\n        .execute();\r\n\r\n      const updatedUserData = updatedUser.raw[0];\r\n      delete updatedUserData.password;\r\n\r\n      return {\r\n        message: 'با موفقیت بروز شد',\r\n        user: updatedUserData,\r\n        status: 200,\r\n      };\r\n    } else {\r\n      const currentUser = await this.userRepository.findOne({\r\n        where: { phone: tokenData.user.phone },\r\n      });\r\n\r\n      if (!currentUser) {\r\n        throw new NotFoundException('کاربری با این شناسه یافت نشد');\r\n      }\r\n\r\n      delete currentUser.password;\r\n\r\n      return { message: 'بدون تغییرات', user: currentUser, status: 200 };\r\n    }\r\n  }\r\n}\r\n"],"names":["UserService","singupUser","createUserDTO","existingUser","userRepository","findOne","where","phone","BadRequestException","NewUser","create","result","save","createUser","hashedPassword","bcrypt","hash","password","createdAt","Date","isSms","smsService","sendSignUpSMS","createResponse","updateUser","updateUserDTO","NotFoundException","Object","assign","updatedAt","deleteUsers","user","manager","transaction","transactionalEntityManager","delete","Subscribe","userPhone","User","getUserByPhone","findOneBy","userInformation","id","firstName","lastName","roles","role","imageUrl","getUsers","page","limit","searchInput","all","sort","sortOrder","allowedSortFields","validatedSortBy","includes","queryBuilder","createQueryBuilder","leftJoinAndSelect","select","groupBy","orderBy","andWhere","undefined","users","getRawMany","adminCount","count","UserRole","ADMIN","userCount","USER","response","data","total","length","totalPages","offset","skip","take","Math","ceil","getAdminCount","getUserCount","getUserDataWithToken","leftJoin","getOne","error","status","editDataUser","authHeader","editData","startsWith","UnauthorizedException","token","split","tokenData","tokenRepository","updateData","keys","updatedUser","update","set","returning","execute","updatedUserData","raw","message","currentUser","constructor"],"mappings":"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"}